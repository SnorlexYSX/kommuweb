---
layout: default
title: Checkout
---

{% include pricing_helpers.html %}

<style>


  body {
    background-color: #000;
  }
  html {
    background-color: #000;
  }

  /* Apple-like mobile summary pane */
  @media (max-width: 768px) {
    /* Turn the whole section into a single card */
    .summary-pane { 
      background: transparent;
      padding-top: 1rem; 
    }
    .summary-card {
      background: #1b1b1b;              /* matches your card tone; change to #fff if desired */
      padding: 3rem;
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
      gap: 0;
    }
  
    /* Stack the columns and add soft separators between blocks */
    .summary-col + .summary-col {
      border-top: 1px solid rgba(255,255,255,.08);
      margin-top: .75rem;
      padding-top: 1rem;
    }
  
    /* Make the checkout button full-width and single line */
    #checkoutBtn {
      width: 100%;
      white-space: nowrap;
    }

    .h3-summary-mobile{
      font-size: calc(1.5rem + .6vw)
    }

    .h5-summary-mobile{
      font-size: calc(1.1rem + .6vw)
    }
  }
  /* Country dropdown chevron — same method as product page */
  select.store-select{
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 8l4 4 4-4' stroke='%23b2b2b2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-size: 1rem;
    background-position: right 1.875rem center;
    -webkit-appearance: none; /* Chrome/Safari */
    -moz-appearance: none;    /* Firefox   */
    appearance: none;
    padding-right: 2.25rem;   /* space for the chevron */
  }
  /* Tighter right inset like product page */
  .store-select-tight{
    background-position: right 0.6rem center !important;
    padding-right: 2rem;
  }
  </style>

<!-- Checkout Page Layout -->
<div class="max-w-6xl mx-auto px-4 py-12">
  <!-- Checkout Title -->
  <div class="text-left mt-2 mb-8">
    <h1 class="h2 font-bold mb-2 text-white">Checkout</h1>
  </div>

  <!-- Form and Cart Summary Layout -->
  <div id="checkoutGrid" class="grid md:grid-cols-2 gap-8">
    <!-- Left Form Fields -->
    <div class="text-white space-y-6">
      <div>
        <label for="checkoutName" class="block h5 font-bold text-gray mb-1">Name</label>
        <input id="checkoutName"
               type="text"
               class="w-full fillform-black px-4 py-2 rounded-checkoutform border-1 btn-border-gray"
               aria-describedby="checkoutNameError"
               autocomplete="given-name"
               required>
        <p id="checkoutNameError" class="text-red-400 text-sm mt-1" hidden>Please enter your first name (letters only).</p>
      </div>
      <div id="checkoutICGroup" class="hidden">
        <label for="checkoutIC" class="block h5 font-bold text-gray mb-1">
          Malaysian IC No. (without –)
        </label>
        <input id="checkoutIC"
               type="text"
               inputmode="numeric"
               autocomplete="off"
               maxlength="12"
               class="w-full fillform-black border-1 btn-border-gray px-4 py-2 rounded-checkoutform"
               pattern="\d{12}"
               aria-describedby="checkoutICHelp checkoutICError"
               required>
        <p id="checkoutICError" class="text-red-400 text-sm mt-1" hidden>Please enter a valid IC number.</p>
      </div>
      <div>
        <label for="checkoutEmail" class="block h5 font-bold text-gray mb-1">Email</label>
        <input id="checkoutEmail" type="email" class="w-full fillform-black border-1 btn-border-gray px-4 py-2 rounded-checkoutform" aria-describedby="checkoutEmailError" required>
        <p id="checkoutEmailError" class="text-red-400 text-sm mt-1" hidden>Please enter a valid email address.</p>
      </div>
      <div>
        <label for="checkoutMobile" class="block h5 font-bold text-gray mb-1">Contact number</label>
        <input id="checkoutMobile"
               type="tel"
               inputmode="tel"
               class="w-full fillform-black border-1 btn-border-gray px-4 py-2 rounded-checkoutform"
               pattern="^\+?[0-9][0-9 \-]{6,}$"
               aria-describedby="checkoutMobileError"
               required>
        <p id="checkoutMobileError" class="text-red-400 text-sm mt-1" hidden>Please provide a valid mobile phone number.</p>
      </div>
      <div>
        <label for="checkoutAddress" class="block h5 font-bold text-gray mb-1">Street Address</label>
        <input id="checkoutAddress"
               type="text"
               class="w-full fillform-black border-1 btn-border-gray px-4 py-2 rounded-checkoutform"
               aria-describedby="checkoutAddressError"
               autocomplete="address-line1"
               required>
        <p id="checkoutAddressError" class="text-red-400 text-sm mt-1" hidden>Please enter a valid street address.</p>
      </div>
      <div>
        <label for="checkoutPostcode" class="block h5 font-bold text-gray mb-1">Postcode</label>
        <input id="checkoutPostcode"
               type="text"
               inputmode="numeric"
               maxlength="10"
               class="w-full fillform-black border-1 btn-border-gray px-4 py-2 rounded-checkoutform"
               pattern="\d{4,10}"
               aria-describedby="checkoutPostcodeError"
               required>
        <p id="checkoutPostcodeError" class="text-red-400 text-sm mt-1" hidden>Please enter 4 to 10 digits.</p>
      </div>
      <div>
        <label for="checkoutCountry" class="block h5 font-bold text-gray mb-1">Country</label>
        <select id="checkoutCountry" class="w-full fillform-black border-1 btn-border-gray px-4 py-2 rounded-checkoutform text-white store-select store-select-tight" required>
          {% for entry in site.data.shipping %}
            <option value="{{ entry.code }}">{{ entry.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="checkoutPromoGroup" class="mt-4">
        <label for="checkoutPromoInput" class="block h5 font-bold text-gray mb-1">Promo code</label>
        <input id="checkoutPromoInput" type="text" class="w-full fillform-black border-1 btn-border-gray px-4 py-2 rounded-checkoutform">
        <p id="checkoutPromoValidity" class="text-yellow-400 mt-1" hidden></p>
      </div>
    </div>

    <!-- Right Cart Summary -->
    <div id="checkoutCartSection" class="text-white">
      <h2 class="h3 font-bold mb-4 text-white">Your Cart</h2>
      <div id="checkoutCartItems" class="space-y-4 mb-6"></div>
      <div class="h5 text-right">
        <p class="mb-1 p-3">Subtotal &nbsp;&nbsp;&nbsp;<span id="checkoutCartSubtotal" class="h5 text-white ml-2">RM0</span></p>
        <p class="h5 text-gray p-3 text-left">Customs duties and import taxes for international orders are not included and may be charged separately by your local authorities.</p>
      </div>
    </div>
  </div>
</div>

<!-- Summary section -->
<section class="w-full bg-card pt-20 summary-pane">
  <div class="max-w-6xl mx-auto px-6 flex flex-col md:flex-row gap-8 summary-card">
    <!-- Col 1: image & headline -->
    <div class="md:w-[40%] summary-col">
      <h2 id="summaryHeading" class="h3 h3-summary-mobile font-bold text-white mb-2">Welcome to Kommunity.</h2>
      <p class="h5 h5-summary-mobile text-gray mb-6">Cruise with intelligence.</p>
      <img
        src="{{ '/img/products/device/checkout_img_cut.webp' | relative_url }}"
        alt="Summary image"
        class="w-full"
      >
    </div>

    <!-- Col 2: placeholder for either product summary or shipping -->
    <div id="summaryCol2" class="md:w-[30%] mt-1 summary-col">
    </div>

    <!-- Col 3: placeholder for either payment summary+CTA or total due-->
    <div id="summaryCol3" class="md:w-[30%] mt-1 summary-col">
    </div>
  </div>
</section>

<!-- Footnotes & T&C -->
<div class="max-w-6xl mx-auto px-4 py-12 h6 text-gray space-y-8">
  <p>Product usage terms <a href="{{ '/terms' | relative_url }}" class="underline text-gray-light">Product T&amp;C</a> apply. Read T&C before you purchase. Accept T&C before you use.</p>
</div>

<script>
  const shippingConfig = {{ site.data.shipping | jsonify }};
  const locale    = KommuPricing.getPreferredLocale();
  const currency  = KommuPricing.getCurrencyCode(locale);
  const formatter = KommuPricing.getFormatter(locale);

  // Format currency without a space between currency and digits (e.g., RM650.00)
  const tightFormat = (amt) => {
    try { return KommuPricing.getFormatter(locale).format(amt).replace(/\s+(?=\d)/g, ""); }
    catch (_) { return String(amt); }
  };

  // Global helpers so both DOM init and checkoutSubmit can use them
  function getDevicePriceByCurrency(curr) {
    try {
      const dev = (products || []).find(p => (p.name||"").toLowerCase() === "kommuassist2");
      if (!dev) return 0;
      const prices = dev.prices || {};
      // Accept curr in any case, fallback to USD
      const ccy = (curr || '').toUpperCase();
      const val = prices[ccy] ?? prices.USD ?? 0;
      return parseFloat(val) || 0;
    } catch (e) { return 0; }
  }

  function computePlan() {
    const ccy = (currency || '').toUpperCase();
    const nonMYR = ccy !== 'MYR';
    const isFromProduct = sessionStorage.getItem('fromProductPage') === 'true';
    const selectionsRaw = sessionStorage.getItem('checkoutSelections');
    const selections = (isFromProduct && selectionsRaw) ? JSON.parse(selectionsRaw) : {};

    // --- derive from checkout_rules.yaml when available ---
    const ctx = {
      source: isFromProduct ? 'product' : 'cart',
      currency: ccy,
      payment: /rent-to-own/i.test(selections.payment||'') ? 'Rent-to-own' : 'One-off Purchase',
      dropdowns: selections
    };
    const thenBlock = KommuPricing.matchRule(ctx) || null;

    // Merge locks from possible buckets in rules (locks / locks_checkout)
    const locksFromRules = Object.assign(
      {},
      (thenBlock && thenBlock.locks) || {},
      (thenBlock && thenBlock.locks_checkout) || {}
    );

    const plan = {
      provider: (thenBlock && thenBlock.provider) || '',
      locks: locksFromRules,
      mode: isFromProduct ? 'product' : 'cart'
    };

    return plan;
  }

  function computePricingForSelections(selections){
    {
        const ctx = {
          source: (sessionStorage.getItem('fromProductPage')==='true') ? 'product' : 'cart',
          currency,
          payment: /rent-to-own/i.test(selections.payment||'') ? 'Rent-to-own' : 'One-off Purchase',
          dropdowns: selections
        };
        const thenBlock   = KommuPricing.matchRule(ctx) || {};
        const promoLabels = (thenBlock.auto_apply?.promotion?.label) ? [thenBlock.auto_apply.promotion.label] : [];
        console.log(promoLabels)
        // Device pricing (promo-aware)
        const deviceOneOff  = KommuPricing.getDevicePriceByCurrency(currency,  promoLabels);
        const deviceMonthly = KommuPricing.getDeviceMonthlyByCurrency(currency, promoLabels);

        // Bundled add-ons from selections (promo/rule-aware)
        const bundled = KommuPricing.getAddonSurchargeFromSelections(selections, currency, thenBlock);

        // Subscription meta (prefer promo override if present)
        let months = 36;
        let subscriptionId = '';
        try {
          const dev = (window.products||[]).find(p => (p.name||'').toLowerCase()==='kommuassist2');
          if (dev?.subscription) {
            months = parseInt(dev.subscription.month || 36, 10) || 36;
            subscriptionId = dev.subscription.id || '';
          }
        } catch(_) {}
        if (thenBlock.auto_apply?.promotion) {
          const sub = KommuPricing.getSubscriptionPromoFromLabels(promoLabels, currency);
          if (sub) {
            if (sub.id)     subscriptionId = sub.id;
            if (sub.months) months = sub.months;
            // If helper also found a promo monthly price, prefer it over deviceMonthly
            if (typeof sub.monthly === 'number' && !Number.isNaN(sub.monthly)) {
              // shadow outer const via object return below
              // we cannot reassign const deviceMonthly here, so we will pass an override flag in return
              var _monthlyOverride = sub.monthly;
            }
          }
        }

        return { thenBlock, promoLabels, deviceOneOff, deviceMonthly: (typeof _monthlyOverride === 'number' ? _monthlyOverride : deviceMonthly), bundled, months, subscriptionId };

    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // ---- Field sanitation & validation helpers ----
    const icEl    = document.getElementById('checkoutIC');
    const mobEl   = document.getElementById('checkoutMobile');
    const pcEl    = document.getElementById('checkoutPostcode');
    const emailEl = document.getElementById('checkoutEmail');
    const addrEl  = document.getElementById('checkoutAddress');
    const nameEl  = document.getElementById('checkoutName');

    // --- realtime validation helpers (debounced + on-blur inline message)
    const validators = [];
    // expose to submit handler
    window.__checkoutValidators = validators;
    const debounce = (fn, ms=400) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

    function attachValidation(el, { errorId, sanitizeDigitsMaxLen = 0, test, message }){
      if (!el) return;
      const errEl = errorId ? document.getElementById(errorId) : null;
      const run = () => {
        // Skip validation for hidden/disabled fields
        const isHidden = (el.offsetParent === null) || !!el.closest('.hidden');
        const isDisabled = el.disabled === true;
        if (isHidden || isDisabled) {
          el.setCustomValidity('');
          if (errEl) { errEl.hidden = true; errEl.textContent = ''; }
          el.classList.remove('ring-1','ring-red-500');
          return true;
        }
        const val = (el.value || '').trim();
        const isRequired = !!el.required;
        let ok;
        if (!isRequired && val === '') {
          // Non-required & empty is OK
          ok = true;
        } else {
          ok = !!test(val);
        }
        el.setCustomValidity(ok ? '' : message);
        if (errEl) {
          if (ok) { errEl.hidden = true; errEl.textContent = ''; }
          else { errEl.hidden = false; errEl.textContent = message; }
        }
        if (ok) {
          el.classList.remove('ring-1','ring-red-500');
        } else {
          el.classList.add('ring-1','ring-red-500');
        }
        return ok;
      };
      // keep for submit-all
      validators.push(run);
      if (sanitizeDigitsMaxLen > 0) {
        el.addEventListener('input', () => {
          const prev = el.value;
          const digits = prev.replace(/\D+/g,'').slice(0, sanitizeDigitsMaxLen);
          if (prev !== digits) el.value = digits;
        });
      }
      el.addEventListener('input', debounce(run, 400));
      ['blur','change'].forEach(evt => el.addEventListener(evt, run));
    }

    // First Name: 2–50 characters, allow letters, spaces, hyphens and apostrophes; must contain at least 2 letters
    attachValidation(nameEl, { errorId: 'checkoutNameError', test: v => {
      const val = (v||'').trim();
      if (val.length < 2 || val.length > 50) return false;
      if (!/^[A-Za-z'\-\s]+$/.test(val)) return false;
      return (val.replace(/[^A-Za-z]/g, '').length >= 2);
    }, message: 'Please enter a valid name.' });
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    attachValidation(emailEl, { errorId: 'checkoutEmailError', test: v => emailRegex.test(v), message: 'Please enter a valid email address.' });
    attachValidation(icEl,    { errorId: 'checkoutICError',    sanitizeDigitsMaxLen: 12, test: v => /^\d{12}$/.test(v), message: 'Please enter exactly 12 digits.' });
    attachValidation(pcEl,    { errorId: 'checkoutPostcodeError', sanitizeDigitsMaxLen: 10, test: v => /^\d{4,10}$/.test(v), message: 'Please enter 4 to 10 digits.' });
    attachValidation(mobEl,   { errorId: 'checkoutMobileError', test: v => /^\+?[0-9][0-9 \-]{6,}$/.test(v), message: 'Please provide a valid mobile phone number.' });
    // Address: at least 5 visible chars and must contain at least one letter or digit
    attachValidation(addrEl, { errorId: 'checkoutAddressError', test: v => {
      const val = (v||'').trim().replace(/\s+/g,' ');
      return val.length >= 5 && /[A-Za-z0-9]/.test(val);
    }, message: 'Please enter a valid street address.' });

    // expose a runner for all validators (used by submit)
    window.__runAllCheckoutValidations = function(){
      let ok = true;
      if (Array.isArray(window.__checkoutValidators)) {
        for (const run of window.__checkoutValidators) {
          if (run && run() === false) ok = false;
        }
      }
      return ok;
    };
    const cartItems      = JSON.parse(localStorage.getItem("cart")) || [];
    const selectionsRaw  = sessionStorage.getItem("checkoutSelections");
    let isFromProduct  = sessionStorage.getItem("fromProductPage") === "true";

    // Resolve source of checkout view

    function applyLocks(plan) {
      const locks = plan.locks || {};
      const ctry = document.getElementById('checkoutCountry');

      // Country lock
      if (locks.country) { ctry.value = locks.country; ctry.disabled = true; } else { ctry.disabled = false; }
      // IC requirement
      if (locks.icRequired === true) { icGroup.classList.remove('hidden'); icInput.required = true; }
      else { icGroup.classList.add('hidden'); icInput.required = false; }
      // Hide promo (cart flows)
      if (locks.hidePromo === true) { promoGroup.classList.add('hidden'); } else { promoGroup.classList.remove('hidden'); }

      // Force selections for product flow (if rules ask for it)
      if (isFromProduct) {
        if (locks.forceOneOff === true)      { selections.payment = 'One-off purchase'; }
        if (locks.forceNoSim === true)       { selections.sim = 'with SIM Card'; }
        if (locks.forceNoTradeIn === true)   { selections.tradeIn = 'No Trade-in'; }
        if (locks.forceSelfInstall === true) { selections.install = 'Self-installation'; }
        sessionStorage.setItem('checkoutSelections', JSON.stringify(selections));
      }
    }
    
    const urlParams = new URLSearchParams(location.search);
    const modeParam = urlParams.get('mode') || urlParams.get('src'); // allow ?mode=cart or ?src=cart
    if (modeParam === 'cart') {
      isFromProduct = false;
      sessionStorage.setItem('fromProductPage', 'false');
    } else if (modeParam === 'product') {
      isFromProduct = true;
      sessionStorage.setItem('fromProductPage', 'true');
    } else {
      // Heuristic: if both product-selection persisted and cart has items, prefer cart flow
      if (isFromProduct && cartItems && cartItems.length > 0) {
        isFromProduct = false;
      }
    }

    const cartSection     = document.getElementById("checkoutCartSection");
    const formGrid        = document.getElementById("checkoutGrid");
    const cartContainer   = document.getElementById("checkoutCartItems");
    const subtotalDisplay = document.getElementById("checkoutCartSubtotal");
    const col2            = document.getElementById("summaryCol2");
    const col3            = document.getElementById("summaryCol3");
    const heading         = document.getElementById("summaryHeading");

    const icGroup    = document.getElementById("checkoutICGroup");
    const icInput    = document.getElementById("checkoutIC");
    const promoGroup = document.getElementById("checkoutPromoGroup");

    let subtotal = 0;
    let selections = {};
    if (isFromProduct && selectionsRaw) {
      selections = JSON.parse(selectionsRaw);
    }

    // When coming from product page in a non-MYR currency (e.g., USD),
    // force dropdown selections to options that are allowed for USD:
    //  - Payment: One-off purchase only (no RTO)
    //  - SIM: Use my own SIM card (no bundled SIM)
    //  - Installation: Self‑installation (international shipping only)
    const _ccyUpper = (currency || '').toUpperCase();
    if (isFromProduct && _ccyUpper !== 'MYR') {
      const s = selections || {};
      // Payment
      if (!/one\s*-?off/i.test(s.payment || '')) {
        s.payment = 'One-off purchase';
      }
      // SIM option
      if (!/own\s*sim/i.test(s.sim || '')) {
        s.sim = 'Use my own SIM card';
      }
      // Installation
      if (!/self\s*-?install/i.test(s.install || '')) {
        s.install = 'Self-installation';
      }
      selections = s;
      // Persist back so downstream helpers (computePlan, summary, submit) see the overrides
      try { sessionStorage.setItem('checkoutSelections', JSON.stringify(selections)); } catch(_) {}
    }

    // Compute plan and apply locks
    const isNonMYRCurrency = (currency || '').toUpperCase() !== 'MYR';
    const plan = computePlan();
    applyLocks(plan);


    // only show IC when user is RTO
    if (
      isFromProduct &&
      selections.payment &&
      selections.payment.toLowerCase().includes("rent-to-own")
    ) {
      icGroup.classList.remove("hidden");
      icInput.required = true;
    } else {
      icGroup.classList.add("hidden");
      icInput.required = false;
    }

    if (isFromProduct) {
      promoGroup.classList.remove("hidden");
    } else {
      promoGroup.classList.add("hidden");
    }
    
    // set default country based on user locale
    const countryInput = document.getElementById("checkoutCountry");
    const defaultCode = locale.split('-')[1]?.toUpperCase() || 'MY';
    // If non-MYR and country is not locked, insert "Select country" placeholder
    if (isNonMYRCurrency && !plan.locks.country) {
      // Only add the placeholder if not already present
      if (!countryInput.querySelector('option[value=""]')) {
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.text = "Select country";
        placeholder.disabled = true;
        placeholder.selected = true;
        placeholder.hidden = true;
        countryInput.insertBefore(placeholder, countryInput.firstChild);
      }
      countryInput.value = "";
      countryInput.disabled = false;
    } else {
      countryInput.value = plan.locks.country || defaultCode;
      if (plan.locks.country) countryInput.disabled = true;
      else countryInput.disabled = false;
    }
    countryInput.addEventListener("change", updateTotalDue);

    // compute shipping cost for default country (product page summary)
    const defaultCountryCode = countryInput.value.trim().toUpperCase();
    const productShipEntry = shippingConfig.find(e => e.code === defaultCountryCode) || {};
    const productShipCost  = parseFloat(productShipEntry.rates?.[currency] || 0);

    if (isFromProduct && Object.keys(selections).length) {

      const payLower = (selections.payment || "").toLowerCase();
      const instLower = (selections.install || "").toLowerCase();
      const allowCountry = payLower.includes("one-off") && instLower.includes("self-installation");

      if (allowCountry) {
        countryInput.disabled = false;
      } else {
        countryInput.value = 'MY';
        countryInput.value = defaultCode;
        countryInput.disabled = true;
      }
      heading.innerText    = "Your new KommuAssist.";
      document.getElementById("checkoutCartSection").style.display = "none";
      document.getElementById("checkoutGrid").classList.remove("md:grid-cols-2");

      let shippingTextInit = '';
      if (defaultCountryCode === 'MY') {
        shippingTextInit = 'Local Shipping\u00a0– Free';
      } else if (productShipEntry && productShipEntry.name && !isNaN(productShipCost) && productShipCost > 0) {
        shippingTextInit = `International Shipping\u00a0– ${productShipEntry.name} ${tightFormat(productShipCost)}`;
      }
      col2.innerHTML = `
        <div>
          <h3 class="h4 font-bold mb-2 text-white">KommuAssist 2</h3>
          <p class="h5 text-gray mb-1 font-medium">${selections.model}</p>
          <p class="h5 text-gray font-medium">${selections.sim}</p>
        </div>
        <div>
          <h3 class="h4 font-bold mb-2 text-white pt-4">Installation</h3>
          <p class="h5 text-gray font-medium">
            ${selections.install}${(/kommu\s*hq/i.test(selections.install) ? '' : (shippingTextInit ? ' - ' + shippingTextInit : ''))}
          </p>
        </div>
      `;

      if (defaultCountryCode === 'MY') {
        (function(){
          const { deviceOneOff, deviceMonthly, bundled, months } = computePricingForSelections(selections);
          const payIsRTO = /rent-to-own/i.test(selections.payment||'');
          const years = (months%12===0) ? (months/12) : null;

          let totalText;
          if (payIsRTO && deviceMonthly>0) {
            totalText = years ? `${tightFormat(deviceMonthly)}/mth for ${years} years` : `${tightFormat(deviceMonthly)}/mth for ${months} months`;
          } else {
            const total = deviceOneOff + (bundled.total||0) + productShipCost;
            totalText = tightFormat(total);
          }

          col3.innerHTML = `
            <h3 class="h4 font-bold mb-2 text-white">Payment</h3>
            <p class="h5 text-gray mb-1 font-medium">${selections.payment}</p>
            <p class="h5 text-gray font-medium">${selections.tradeIn}</p>
            <h3 class="h4 font-bold mt-6 mb-2 text-white">Total Due</h3>
            <p id="totalDue" class="h5 text-gray mb-4 font-normal">${totalText}</p>
            <div class="mt-6 flex justify-center">
              <button
                class="h5 bg-blue-600 hover:bg-blue-700 text-white px-20 w-full py-2 rounded-checkout whitespace-nowrap"
                onclick="checkoutSubmit()"
              >
                Continue to Payment
              </button>
            </div>
          `;
        })();
      } else {
      col3.innerHTML = `
          <div>
            <h3 class="h4 font-bold mb-2 text-white">Total Due</h3>
            <p id="totalDue" class="h5 text-gray mb-4 font-normal"></p>
            <div class="flex justify-center">
              <button
                class="h5 bg-blue-600 hover:bg-blue-700 text-white px-20 w-full py-2 rounded-checkout whitespace-nowrap"
                onclick="checkoutSubmit()"
              >
                Continue to Payment
              </button>
            </div>
          </div>
        `;
      }

    } else {
      // → STORE/CART PAGE SUMMARY
      let shippingText;

      // (countryInput.value already set above)
      countryInput.disabled = false;
      const selectedCode = (countryInput.value || '').trim().toUpperCase();
      if (selectedCode === "MY") {
        shippingText = "Local Shipping\u00a0– Free";
      } else if (productShipEntry && productShipEntry.name && !isNaN(productShipCost) && productShipCost > 0) {
        shippingText = `International Shipping\u00a0– ${productShipEntry.name} ${tightFormat(productShipCost)}`;
      } else if (isNonMYRCurrency && !plan.locks.country) {
        shippingText = "Select country";
      } else {
        shippingText = "Select country to see shipping";
      }

      col2.innerHTML = `
        <div>
          <h3 class="h4 font-bold mb-2 text-white">Shipping</h3>
          <p class="h5 text-gray font-normal">
            ${shippingText}
          </p>
        </div>
      `;

      col3.innerHTML = `
        <div>
          <h3 class="h4 font-bold mb-2 text-white">Total Due</h3>
          <p id="totalDue" class="h5 text-gray mb-4 font-normal"></p>
          <div class="flex justify-center">
            <button
              class="h5 bg-blue-600 hover:bg-blue-700 text-white px-20 w-full py-2 rounded-checkout whitespace-nowrap"
              onclick="checkoutSubmit()"
            >
              Continue to Payment
            </button>
          </div>
        </div>
      `;
    }

    cartItems.forEach(item => {


      const unitPrice = item.prices?.[currency] ?? item.prices?.USD ?? 0;
      const qty       = item.quantity ?? 1;
      const itemTotal = unitPrice * qty;

      const card = document.createElement("div");
      card.className = "flex items-center gap-4 p-3 bg-black";

      const imgWrapper = document.createElement("div");
      imgWrapper.className = "bg-card p-2 rounded-lg";
      const img = document.createElement("img");
      img.src = item.image;
      img.alt = item.name;
      img.className = "w-16 h-16 object-contain";
      imgWrapper.appendChild(img);

      // details
      const details = document.createElement("div");
      details.className = "flex-1";
      const title = document.createElement("p");
      title.className = "h4 font-bold text-white";
      title.innerText = item.name;
      const quantityP = document.createElement("p");
      quantityP.className = "h5 text-gray";
      quantityP.innerText = `Qty: ${qty}`;
      const desc = document.createElement("p");
      desc.className = "h5 text-gray";
      desc.innerText = item.selection || "";

      details.appendChild(title);
      details.appendChild(quantityP);
      details.appendChild(desc);

      // price
      const priceEl = document.createElement("p");
      priceEl.className = "h5 font-medium text-right";
      priceEl.innerText = tightFormat(itemTotal);

      // assemble
      card.appendChild(imgWrapper);
      card.appendChild(details);
      card.appendChild(priceEl);
      cartContainer.appendChild(card);

      // accumulate
      subtotal += itemTotal;
    });

    subtotalDisplay.innerText = tightFormat(subtotal);

    function updateTotalDue() {
      const countryCode = countryInput.value.trim().toUpperCase();
      const totalDueDisplay = document.getElementById("totalDue");

      // find the matching shipping entry
      const entry = shippingConfig.find(e => e.code === countryCode) || {};
      const shipCost = parseFloat(entry.rates?.[currency] || 0);
      let shippingText;
      const ccy = (currency || '').toUpperCase();

      // update shipping column
      const countryName = entry.name || countryCode;
      if (countryCode === "MY") {
        shippingText = "Local Shipping – Free";
      } else if (entry && entry.name && !isNaN(shipCost) && shipCost > 0) {
        shippingText = `International Shipping – ${entry.name} ${tightFormat(shipCost)}`;
      } else if (ccy !== 'MYR') {
        shippingText = "Select country";
      } else {
        shippingText = ""; // not selected / unknown yet
      }
      if(isFromProduct) {
        col2.innerHTML=`
        <div>
          <h3 class="h4 font-bold mb-2 text-white">KommuAssist 2</h3>
          <p class="h5 text-gray mb-1 font-medium">${selections.model}</p>
          <p class="h5 text-gray font-medium">${selections.sim}</p>
        </div>
        <div>
          <h3 class="h4 font-bold mb-2 text-white pt-4">Installation</h3>
          <p class="h5 text-gray font-medium">
            ${selections.install}${(/kommu\s*hq/i.test(selections.install) ? '' : (shippingText ? ' - ' + shippingText : ''))}
          </p>
        </div>
        `;
        
        if (countryCode === 'MY') {
          (function(){
            const { deviceOneOff, deviceMonthly, bundled, months } = computePricingForSelections(selections);
            const payIsRTO = /rent-to-own/i.test(selections.payment||'');
            const years = (months%12===0) ? (months/12) : null;

            let totalText;
            if (payIsRTO && deviceMonthly>0) {
              totalText = years ? `${tightFormat(deviceMonthly)}/mth for ${years} years` : `${tightFormat(deviceMonthly)}/mth for ${months} months`;
            } else {
              const total = deviceOneOff + (bundled.total||0) + shipCost;
              totalText = tightFormat(total);
            }

            col3.innerHTML = `
              <h3 class="h4 font-bold mb-2 text-white">Payment</h3>
              <p class="h5 text-gray mb-1 font-medium">${selections.payment}</p>
              <p class="h5 text-gray font-medium">${selections.tradeIn}</p>
              <h3 class="h4 font-bold mt-6 mb-2 text-white">Total Due</h3>
              <p id="totalDue" class="h5 text-gray mb-4 font-normal">${totalText}</p>
              <div class="mt-6 flex justify-center">
                <button
                  class="h5 bg-blue-600 hover:bg-blue-700 text-white px-20 w-full py-2 rounded-checkout whitespace-nowrap"
                  onclick="checkoutSubmit()"
                >
                  Continue to Payment
                </button>
              </div>
            `;
          })();
        } else {
          (function(){
            const { deviceOneOff, deviceMonthly, bundled, months } = computePricingForSelections(selections);
            const payIsRTO = /rent-to-own/i.test(selections.payment||'');
            const years = (months%12===0) ? (months/12) : null;

            let totalText;
            if (payIsRTO && deviceMonthly>0) {
              totalText = years ? `${tightFormat(deviceMonthly)}/mth for ${years} years` : `${tightFormat(deviceMonthly)}/mth for ${months} months`;
            } else {
              const total = deviceOneOff + (bundled.total||0) + shipCost;
              totalText = tightFormat(total);
            }

            col3.innerHTML = `
              <div>
                <h3 class="h4 font-bold mb-2 text-white">Total Due</h3>
                <p class="h5 text-gray font-normal">${selections.payment}</p>
                <p id="totalDue" class="h5 text-gray mb-10 font-normal">${totalText}</p>
                <div class="flex justify-center">
                  <button
                    class="h5 bg-blue-600 hover:bg-blue-700 text-white px-20 w-full py-2 rounded-checkout whitespace-nowrap"
                    onclick="checkoutSubmit()"
                  >
                    Continue to Payment
                  </button>
                </div>
              </div>
            `;
          })();
        }
      } else {
        totalDueDisplay.innerText = tightFormat(subtotal + shipCost);
        col2.innerHTML = `
          <div>
            <h3 class="h4 font-bold mb-2 text-white">Shipping</h3>
            <p class="h5 text-gray font-normal">
              ${shippingText}
            </p>
          </div>
        `;
      }
    }

    updateTotalDue();
  });


const visaUrl = "https://aws.kommu.ai/curlec/visa?";
const otpUrl = "https://aws.kommu.ai/curlec/otp?";
const stripeUrl = "https://aws.kommu.ai/stripe/checkout?";

// Helper: Smoothly scroll to a field with offset for sticky headers
function __scrollToField(el){
  if (!el) return;
  try {
    const rect = el.getBoundingClientRect();
    const y = rect.top + window.pageYOffset - 100; // offset for top padding/header
    window.scrollTo({ top: y, behavior: 'smooth' });
  } catch(_) {
    // fallback
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

function checkoutSubmit() {
  var fromProduct   = false;
  const _urlParams = new URLSearchParams(location.search);
  const _modeParam = _urlParams.get('mode') || _urlParams.get('src');
  if ((_modeParam === 'product') || (sessionStorage.getItem('fromProductPage') === 'true'))  fromProduct = true; 
  const selectionsRaw = sessionStorage.getItem('checkoutSelections');
  const selections    = selectionsRaw ? JSON.parse(selectionsRaw) : {};

  // Plan calculation for submission (recompute with latest selections)
  const plan = (function(){
    const sRaw = sessionStorage.getItem('checkoutSelections');
    const s = sRaw ? JSON.parse(sRaw) : {};
    return (function(sel){
      // reuse computePlan with current selections
      return computePlan();
    })(s);
  })();

  const useVisa = (plan.provider === 'curlec-sub');
  const pricing = computePricingForSelections(selections);

  // common form values
  const name     = document.getElementById("checkoutName").value.trim();
  const ic       = document.getElementById("checkoutIC").value.trim();
  const email    = document.getElementById("checkoutEmail").value.trim();
  const mobile   = document.getElementById("checkoutMobile").value.trim();
  const addr1    = document.getElementById("checkoutAddress").value.trim();
  const addr2    = "";
  const postcode = document.getElementById("checkoutPostcode").value.trim();
  const country  = document.getElementById("checkoutCountry").value.trim().toUpperCase();

  // basic validation (inline errors; block submit if any invalid)
  let allOK = true;
  // trigger field validators to show error text
  if (typeof window.__runAllCheckoutValidations === 'function') {
    allOK = window.__runAllCheckoutValidations();
  }
  console.log(allOK)

  // also ensure required built-in constraints are respected
  const requiredEls = [
    document.getElementById('checkoutName'),
    document.getElementById('checkoutEmail'),
    document.getElementById('checkoutMobile'),
    document.getElementById('checkoutAddress'),
    document.getElementById('checkoutPostcode'),
    document.getElementById('checkoutCountry')
  ];
  const icField = document.getElementById('checkoutIC');
  if (icField && icField.required) requiredEls.push(icField);

  let firstInvalid = null;
  for (const el of requiredEls) {
    if (!el) continue;
    if (!el.checkValidity()) {
      allOK = false;
      el.classList.add('ring-1','ring-red-500');
      if (!firstInvalid) firstInvalid = el;
    } else {
      el.classList.remove('ring-1','ring-red-500');
    }
  }
  if (!allOK) {
    // scroll to the first invalid field and focus it
    if (firstInvalid) {
      __scrollToField(firstInvalid);
      // focus slightly after scroll begins for mobile browsers
      setTimeout(() => { try { firstInvalid.focus({ preventScroll: true }); } catch(_) { firstInvalid.focus(); } }, 250);
    }
    return; // stop here if anything is invalid
  }

  // calculate subtotal and shipping
  const subText = document.getElementById("checkoutCartSubtotal").innerText.replace(/[^\d.]/g,"");
  const promoCode = document.getElementById("checkoutPromoInput")?.value.trim().toUpperCase() || "";
  let devicePrice = 0;
  if (fromProduct) {
    devicePrice = pricing.deviceOneOff + (pricing.bundled.total||0);
  } else {
    devicePrice = parseFloat(subText) || 0;
  }
  const entry = shippingConfig.find(e => e.code === country) || {};
  const ship  = parseFloat(entry.rates?.[currency] || 0);

  // build params & redirect
  if (useVisa) {
    // rent-to-own → Visa URL
    const duration = pricing.months;
    const subscriptionId = pricing.subscriptionId || ((products.find(p => (p.name||"").toLowerCase()==="kommuassist2")?.subscription?.id) || "");
    const monthlyPayment = (pricing.deviceMonthly || 0).toFixed(2);
    const visaItems = [{
      sim:         selections.sim || "",
      tradeIn:     selections.tradeIn || ""
    }];

    const params = new URLSearchParams();
    params.append("name",             name);
    params.append("email",            email);
    params.append("mobile",           mobile);
    params.append("address1",         addr1);
    params.append("address2",         addr2);
    params.append("postcode",         postcode);
    params.append("nric",             ic);
    params.append("duration",         duration);
    params.append("subscription",     subscriptionId);
    params.append("harness",          selections.model || "");
    params.append("amount",           devicePrice.toFixed(2));
    params.append("monthlyPayment",   monthlyPayment);
    params.append("installation",     selections.install || "");
    params.append("promoCode",        promoCode);
    params.append("deviceProperties", JSON.stringify(visaItems));
    params.append("country",           "Malaysia");
    params.append("currency",          "MYR");

    sessionStorage.setItem("customerName", name);
    window.open(visaUrl + params.toString(), "_blank");
    return;
  }

  // default: One-time payment → OTP or Stripe URL
  const total = devicePrice + ship;
  let lineItems;

  const otpParams = new URLSearchParams({
    name,
    ic,
    email,
    mobile,
    address1: addr1,
    address2: addr2,
    postcode,
    country: entry.name || country,
    currency: (currency || 'MYR'),
    harness: (selections.model || ""),
    installation: (selections.install || ""),
    deviceprice:  devicePrice.toFixed(2),
    shippingrate: ship.toFixed(2),
    amount:       total.toFixed(2),
    promoCode
  });
  if (fromProduct) {
    const deviceProps = {
      sim:     selections.sim || "",
      tradeIn: selections.tradeIn || ""
    };
    otpParams.append("deviceProperties", JSON.stringify(deviceProps));
  } else {
    const cartItems = JSON.parse(localStorage.getItem("cart")) || [];
    lineItems = cartItems.map(i => ({
      name:      i.name,
      quantity:  i.quantity || 1,
      unitPrice: (i.prices[currency]||i.prices.USD).toFixed(2),
      subcategory: i.selection
    }));
  }
  // Always append cart items when present
  if (lineItems && lineItems.length) {
    otpParams.append("items", JSON.stringify(lineItems));
  }

  sessionStorage.setItem("customerName", name);

  let targetUrl = otpUrl;
  if (plan.provider === 'stripe') targetUrl = stripeUrl;
  if (plan.provider === 'curlec-otp') targetUrl = otpUrl;

  // Enforce country/currency for each case
  if (plan.mode === 'product') {
    if (plan.provider === 'curlec-otp') {
      otpParams.set('country', 'Malaysia');
      otpParams.set('currency', 'MYR');
    }
    if (plan.provider === 'stripe') {
      // country(name) already from dropdown; currency already set above
      // also force one-off & locks already applied in selections
    }
  } else {
    // cart accessories-only
    if (plan.provider === 'curlec-otp') {
      otpParams.set('country', 'Malaysia');
      otpParams.set('currency', 'MYR');
    }
  }

  window.open(targetUrl + otpParams.toString(), "_blank");
}

</script>
