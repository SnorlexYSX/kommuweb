<!-- Navigation -->
<div class="md:hidden">
<nav class="fixed inset-x-0 top-0 z-50 bg-black py-2">
  <div class="container mx-auto flex items-center justify-between px-4 relative z-50">

    <!-- Left: Logo -->
    <a href="{{ '/' | relative_url }}" class="flex items-center gap-2 text-white">
      <img src="{{ '/img/kommu-logo.png' | relative_url }}" alt="Kommu" class="h-6 w-auto"/>
      <span class="sr-only">Kommu</span>
    </a>

    <!-- Right: Cart + Burger -->
    <div class="flex items-center gap-4">
      <!-- Cart Icon -->
      <button onclick="toggleCart()" class="relative text-white text-lg" aria-label="Open cart">
        ðŸ›’
        <span id="cartCount" class="absolute -top-2 -right-2 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center"
         style="background-color: #2d2d2d;">
         0</span>
      </button>

      <!-- Burger -->
      <button id="navToggle" class="inline-flex items-center justify-center rounded-md p-2 text-white focus:outline-none" aria-controls="mobileNav" aria-expanded="false" aria-label="Toggle navigation">
        <svg id="iconOpen" class="h-6 w-6" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <svg id="iconClose" class="h-6 w-6 hidden" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile/Overlay Panel: Tabs + Currency Selector -->
  <div id="mobileNav" class="hidden border-t border-[rgba(255,255,255,.08)] bg-black relative z-50" role="region" aria-label="Navigation Menu">
    <div class="container mx-auto px-4 py-4">
      <nav class="flex flex-col gap-3 text-gray-300 text-md font-normal">
        <a href="{{ '/' | relative_url }}" class="py-2">Home</a>
        <a href="{{ '/ka2' | relative_url }}" class="py-2">KommuAssist 2</a>
        <a href="{{ '/store' | relative_url }}" class="py-2">Store</a>
        <a href="{{ '/support' | relative_url }}" class="py-2">Supported Cars</a>

        <div class="mt-3 h-px border-t border-[rgba(255,255,255,.08)]"></div>

        <!-- Currency / Locale Selector -->
        <label for="localeSelectorMobile" class="h6 text-gray">Currency</label>
        <select id="localeSelectorMobile" class="bg-black text-white px-2 py-2 h5 rounded w-full">
          <option value="en-MY" selected>ðŸ‡²ðŸ‡¾ MYR</option>
          <option value="en-US">ðŸ‡ºðŸ‡¸ USD</option>
        </select>
      </nav>
    </div>
  </div>

  <!-- Backdrop overlay for mobile nav -->
  <div id="mobileOverlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-30" onclick="closeMobileNav()"></div>
</nav>

</div>

<!-- Desktop / Tablet Navigation -->
<div class="hidden md:block">
  <nav class="fixed inset-x-0 top-0 z-50 bg-black py-2">
    <div class="container mx-auto flex items-center justify-center px-6">
      <!-- Center: Tabs/links -->
      <nav class="flex items-center gap-12 text-md font-normal text-white">
        <a href="{{ '/' | relative_url }}" class="flex items-center gap-2 text-white">
          <img src="{{ '/img/kommu-logo.png' | relative_url }}" alt="Kommu" class="h-4 w-auto"/>
          <span class="sr-only">Kommu</span>
        </a>
        <a href="{{ '/' | relative_url }}" class="hover:text-gray-300">Home</a>
        <a href="{{ '/ka2' | relative_url }}" class="hover:text-gray-300">KommuAssist 2</a>
        <a href="{{ '/store' | relative_url }}" class="hover:text-gray-300">Store</a>
        <a href="{{ '/support' | relative_url }}" class="hover:text-gray-300">Supported Cars</a>
        <select id="localeSelectorDesktop" class="bg-black text-white px-2 py-2 text-sm rounded">
          <option value="en-MY">ðŸ‡²ðŸ‡¾ MYR</option>
          <option value="en-US">ðŸ‡ºðŸ‡¸ USD</option>
        </select>
        <button onclick="toggleCart()" class="relative text-white text-xl" aria-label="Open cart">
          ðŸ›’
          <span id="cartCountDesktop" class="absolute -top-1.5 -right-2 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center"
                style="background-color: #2d2d2d;">0</span>
        </button>
      </nav>
    </div>
  </nav>
</div>


<script>

  // Keep existing locale/currency helpers; moved selector into the menu
  const localeSelectorMobile = document.getElementById("localeSelectorMobile");
  const localeSelectorDesktop = document.getElementById("localeSelectorDesktop");

  // (function(){
  //   if (!localStorage.getItem("preferredLocale")) {
  //     // Hide page until we resolve locale (max 500ms)
      
  //   }
  // })();
  async function getGeoLocale() {
    const saved = localStorage.getItem("preferredLocale");
    if (saved) return saved;

    const browserLang = (navigator.language && navigator.language.split("-")[0]) || "en";
    let locale = navigator.language || "en-US";

    function timeout(ms){
      return new Promise(resolve => setTimeout(() => resolve("__TIMEOUT__"), ms));
    }

    try {
      const winner = await Promise.race([
        fetch("https://ipapi.co/json/"),
        timeout(500)
      ]);

      if (winner !== "__TIMEOUT__" && winner && winner.ok) {
        const { country_code } = await winner.json();
        if (country_code) {
          locale = `${browserLang}-${country_code}`;
        }
      }
    } catch(_) { /* ignore network errors */ }

    localStorage.setItem("preferredLocale", locale);
    location.reload();
    return locale;
  }

  (async () => {
    document.documentElement.style.visibility = 'hidden';

    const locale = await getGeoLocale();

    if (localeSelectorMobile)  localeSelectorMobile.value    = locale;
    if (localeSelectorDesktop) localeSelectorDesktop.value   = locale;

    // Reveal page now that locale is ready (or timed out)
    document.documentElement.style.visibility = '';

    function onChange(val){
      localStorage.setItem("preferredLocale", val);
     // window.dispatchEvent(new CustomEvent('locale:changed'));
      location.reload();
    }

    localeSelectorMobile?.addEventListener("change", e => onChange(e.target.value));
    localeSelectorDesktop?.addEventListener("change",   e => onChange(e.target.value));
  })();

  function getCurrencyCode(locale) {
    const country = locale.split("-")[1] || "US";
    const currencyMap = { MY: "MYR", US: "USD", SG: "SGD", JP: "JPY", GB: "GBP" };
    return currencyMap[country] || "USD";
  }

  function getFormatter(locale) {
    const currency = getCurrencyCode(locale);
    return new Intl.NumberFormat(locale, { style: "currency", currency, minimumFractionDigits: 2 });
  }

  function formatPrice(prices) {
    const locale = localStorage.getItem("preferredLocale") || navigator.language || "en-US";
    const currency = getCurrencyCode(locale);
    const formatter = getFormatter(locale);
    const price = prices[currency] || prices["USD"] || 0;
    return formatter.format(price);
  }
</script>
<script>
  // -- Burger toggle logic --
  (function () {
    const toggle = document.getElementById('navToggle');
    const panel  = document.getElementById('mobileNav');
    const openI  = document.getElementById('iconOpen');
    const closeI = document.getElementById('iconClose');
    const overlay = document.getElementById('mobileOverlay');
    let open = false;

    function setOpen(v) {
      open = v;
      panel.classList.toggle('hidden', !open);
      openI.classList.toggle('hidden', open);
      closeI.classList.toggle('hidden', !open);
      toggle?.setAttribute('aria-expanded', String(open));
      document.documentElement.classList.toggle('overflow-hidden', open); // lock scroll when open
      overlay?.classList.toggle('hidden', !open);
    }

    toggle?.addEventListener('click', () => setOpen(!open));
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && open) setOpen(false); });

    window.closeMobileNav = () => setOpen(false);
  })();
</script>